name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf automake libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev expect
    
    - name: Install Buildozer and dependencies
      run: |
        pip install buildozer cython
    
    - name: Build APK
      timeout-minutes: 180
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME || '/usr/local/lib/android/sdk' }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT || '/usr/local/lib/android/sdk' }}
      run: |
        # Prepara diretórios para licenças
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        echo "Iniciando build do APK..."
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer --version || echo 'não disponível')"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        # Aceita licenças do Android SDK se o sdkmanager estiver disponível
        if command -v sdkmanager &> /dev/null; then
          echo "Aceitando licenças do Android SDK..."
          yes | sdkmanager --licenses || true
        fi
        
        # Configura variáveis de ambiente para o build
        export AUTOCONF_VERSION=$(autoconf --version | head -1 | awk '{print $NF}')
        export AUTOMAKE_VERSION=$(automake --version | head -1 | awk '{print $NF}')
        echo "Autoconf version: $AUTOCONF_VERSION"
        echo "Automake version: $AUTOMAKE_VERSION"
        
        # Executa buildozer diretamente
        # O buildozer.spec já tem android.accept_sdk_license = True
        # Usa timeout para evitar travamentos
        set +e
        timeout 10800 buildozer android debug 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        # Timeout retorna 124
        if [ $BUILD_EXIT_CODE -eq 124 ]; then
          echo "⚠️ Build atingiu timeout de 3 horas"
          BUILD_EXIT_CODE=1
        fi
        
        # Verifica se o build realmente falhou ou se apenas teve warnings
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "=== Build retornou código: $BUILD_EXIT_CODE ==="
          echo "Verificando se APK foi gerado mesmo assim..."
          
          # Verifica se APK foi gerado
          APK_COUNT=$(find .buildozer bin -name "*.apk" 2>/dev/null | wc -l)
          if [ $APK_COUNT -gt 0 ]; then
            echo "✅ APK foi gerado apesar do código de saída!"
            BUILD_EXIT_CODE=0
          else
            echo "❌ Nenhum APK encontrado. Build realmente falhou."
            echo "=== Procurando por erros no log ==="
            grep -i "error\|fail\|exception\|traceback" build.log | tail -100 || echo "Nenhum erro específico encontrado"
            echo "=== Últimas 1000 linhas do log ==="
            tail -1000 build.log
            echo "=== Verificando estrutura de diretórios ==="
            find .buildozer -type f -name "*.apk" 2>/dev/null || echo "Nenhum APK em .buildozer"
            find bin -type f -name "*.apk" 2>/dev/null || echo "Nenhum APK em bin"
            echo "=== Verificando se SDK foi baixado ==="
            ls -la ~/.buildozer/android/platform/ 2>/dev/null || echo "Diretório platform não encontrado"
            echo "=== Verificando logs do buildozer ==="
            find .buildozer -name "*.log" -exec tail -50 {} \; 2>/dev/null || echo "Nenhum log adicional encontrado"
            exit 1
          fi
        fi
        
        echo "=== Build concluído com sucesso ==="
        echo "Procurando APKs gerados..."
        find .buildozer -name "*.apk" -exec ls -lh {} \;
        find bin -name "*.apk" -exec ls -lh {} \; 2>/dev/null || true
        
        # Encontra o primeiro APK e salva o caminho
        APK_PATH=$(find .buildozer bin -name "*.apk" 2>/dev/null | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "ERRO: Nenhum APK encontrado!"
          echo "Estrutura de diretórios:"
          ls -la .buildozer/ 2>/dev/null || true
          ls -la bin/ 2>/dev/null || true
          exit 1
        fi
        echo "APK encontrado em: $APK_PATH"
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: mritgateway-apk
        path: ${{ env.APK_PATH }}
      if: env.APK_PATH != ''

