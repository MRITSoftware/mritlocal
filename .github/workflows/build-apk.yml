name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev
    
    - name: Install Buildozer and dependencies
      run: |
        pip install buildozer cython
    
    - name: Build APK
      timeout-minutes: 60
      run: |
        # Prepara diretórios para licenças
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        echo "Iniciando build do APK..."
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer --version || echo 'não disponível')"
        
        # Executa buildozer com logging detalhado
        # Usa expect ou yes para aceitar licenças automaticamente
        buildozer android debug 2>&1 | tee build.log || {
          echo "=== Build falhou ==="
          echo "Últimas 200 linhas do log:"
          tail -200 build.log
          echo "=== Verificando arquivos gerados ==="
          find .buildozer -name "*.apk" 2>/dev/null || echo "Nenhum APK encontrado"
          echo "=== Fim do log ==="
          exit 1
        }
        
        echo "=== Build concluído com sucesso ==="
        echo "APKs gerados:"
        find .buildozer -name "*.apk" -exec ls -lh {} \;
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: mritgateway-apk
        path: .buildozer/android/platform/build/dists/mritgateway/bin/*.apk

