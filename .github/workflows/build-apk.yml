name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev expect
    
    - name: Install Buildozer and dependencies
      run: |
        pip install buildozer cython
    
    - name: Build APK
      timeout-minutes: 60
      run: |
        # Prepara diretórios para licenças
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        echo "Iniciando build do APK..."
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer --version || echo 'não disponível')"
        
        # Cria script expect para aceitar licenças automaticamente
        printf '#!/usr/bin/expect -f\n' > accept_licenses.exp
        printf 'set timeout 3600\n' >> accept_licenses.exp
        printf 'spawn buildozer android debug\n' >> accept_licenses.exp
        printf 'expect {\n' >> accept_licenses.exp
        printf '    "*license*" { send "y\\r"; exp_continue }\n' >> accept_licenses.exp
        printf '    "*License*" { send "y\\r"; exp_continue }\n' >> accept_licenses.exp
        printf '    "*accept*" { send "y\\r"; exp_continue }\n' >> accept_licenses.exp
        printf '    "*Accept*" { send "y\\r"; exp_continue }\n' >> accept_licenses.exp
        printf '    timeout { puts "Timeout!"; exit 1 }\n' >> accept_licenses.exp
        printf '    eof { catch wait result; exit [lindex $result 3] }\n' >> accept_licenses.exp
        printf '}\n' >> accept_licenses.exp
        chmod +x accept_licenses.exp
        
        # Executa buildozer com expect para aceitar licenças
        set +e
        ./accept_licenses.exp 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "=== Build falhou (código: $BUILD_EXIT_CODE) ==="
          echo "Últimas 200 linhas do log:"
          tail -200 build.log
          echo "=== Verificando arquivos gerados ==="
          find .buildozer -name "*.apk" 2>/dev/null || echo "Nenhum APK encontrado"
          exit 1
        fi
        
        echo "=== Build concluído com sucesso ==="
        echo "Procurando APKs gerados..."
        find .buildozer -name "*.apk" -exec ls -lh {} \;
        find bin -name "*.apk" -exec ls -lh {} \; 2>/dev/null || true
        
        # Encontra o primeiro APK e salva o caminho
        APK_PATH=$(find .buildozer bin -name "*.apk" 2>/dev/null | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "ERRO: Nenhum APK encontrado!"
          echo "Estrutura de diretórios:"
          ls -la .buildozer/ 2>/dev/null || true
          ls -la bin/ 2>/dev/null || true
          exit 1
        fi
        echo "APK encontrado em: $APK_PATH"
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: mritgateway-apk
        path: ${{ env.APK_PATH }}
      if: env.APK_PATH != ''

