name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev
    
    - name: Install Buildozer and dependencies
      run: |
        pip install buildozer cython
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Accept Android SDK licenses
      run: |
        yes | sdkmanager --licenses || true
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
    
    - name: Build APK
      timeout-minutes: 60
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      run: |
        echo "Iniciando build do APK..."
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        # Executa buildozer com logging detalhado
        buildozer android debug 2>&1 | tee build.log || {
          echo "=== Build falhou ==="
          echo "Últimas 100 linhas do log:"
          tail -100 build.log
          echo "=== Fim do log ==="
          exit 1
        }
        
        echo "=== Build concluído com sucesso ==="
        ls -la .buildozer/android/platform/build/dists/mritgateway/bin/ || true
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: mritgateway-apk
        path: .buildozer/android/platform/build/dists/mritgateway/bin/*.apk

