name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          cmake \
          libffi-dev \
          libssl-dev \
          build-essential \
          ccache
    
    - name: Set up Java environment
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
    
    - name: Install Buildozer and dependencies
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython
    
    - name: Initialize Buildozer
      run: |
        buildozer init || true
    
    - name: Accept Android SDK licenses
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        mkdir -p ~/.android/licenses
        # Licenças principais do Android SDK (hashes SHA-256)
        echo "24333f8a63b6825ea9c5514f83c2829b1d24e05b" > ~/.android/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/android-sdk-preview-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.android/licenses/android-sdk-armeabi-v7a-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > ~/.android/licenses/android-sdk-arm64-v8a-license
        echo "33b6a33b8c0e1e4c0e1e4c0e1e4c0e1e4c0e1e4c0" > ~/.android/licenses/android-googletv-license
        echo "8403addf88ab4874007e1c1e80a0025de956b318" > ~/.android/licenses/android-sdk-intel-license
        # Licença do Build-Tools (mesmo hash do arm64-v8a)
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > ~/.android/licenses/android-sdk-build-tools-license || true
    
    - name: Configure Buildozer environment
      run: |
        export ANDROIDSDK="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROIDNDK="$HOME/.buildozer/android/platform/android-ndk-r25c"
        export ANDROIDAPI=31
        export ANDROIDMINAPI=21
        echo "ANDROIDSDK=$ANDROIDSDK" >> $GITHUB_ENV
        echo "ANDROIDNDK=$ANDROIDNDK" >> $GITHUB_ENV
        echo "ANDROIDAPI=$ANDROIDAPI" >> $GITHUB_ENV
        echo "ANDROIDMINAPI=$ANDROIDMINAPI" >> $GITHUB_ENV
    
    - name: Build APK
      timeout-minutes: 90
      env:
        USE_CCACHE: 1
        CCACHE_DIR: ${{ runner.temp }}/ccache
      run: |
        # Não usa set -e para permitir tratamento de erros manual
        set +e
        
        echo "=== Configuração ==="
        echo "Python: $(python --version)"
        echo "Buildozer: $(buildozer --version 2>&1 | head -1)"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "Diretório: $(pwd)"
        echo "JAVA_HOME: $JAVA_HOME"
        
        echo "=== Limpando builds anteriores ==="
        # Só limpa se o diretório existir para evitar erros
        if [ -d ".buildozer/android/platform/python-for-android" ]; then
          buildozer android clean || true
        fi
        
        echo "=== Preparando ambiente Android SDK ==="
        # Cria diretório do SDK se não existir
        SDK_PATH="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$SDK_PATH/licenses"
        # Copia licenças para o diretório do SDK também
        cp -r ~/.android/licenses/* "$SDK_PATH/licenses/" 2>/dev/null || true
        
        # Instala cmdline-tools se não existir (necessário para versões recentes do buildozer)
        if [ ! -f "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "=== Instalando Android SDK cmdline-tools ==="
          mkdir -p "$SDK_PATH/cmdline-tools"
          ORIGINAL_DIR=$(pwd)
          cd "$SDK_PATH" || exit 1
          # Tenta baixar a versão mais recente do cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip || \
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip || true
          if [ -f cmdline-tools.zip ]; then
            unzip -q cmdline-tools.zip -d cmdline-tools-temp
            rm cmdline-tools.zip
            # Move para a estrutura esperada (cmdline-tools/latest/)
            if [ -d cmdline-tools-temp/cmdline-tools ]; then
              mv cmdline-tools-temp/cmdline-tools/* cmdline-tools/ 2>/dev/null || true
            else
              mkdir -p cmdline-tools/latest
              mv cmdline-tools-temp/* cmdline-tools/latest/ 2>/dev/null || true
            fi
            rm -rf cmdline-tools-temp
          fi
          cd "$ORIGINAL_DIR" || true
        fi
        
        # Cria symlink para o caminho antigo que o buildozer espera
        if [ -f "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" ] && [ ! -d "$SDK_PATH/tools" ]; then
          echo "=== Criando symlink para compatibilidade com buildozer ==="
          mkdir -p "$SDK_PATH/tools/bin"
          ln -sf "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" "$SDK_PATH/tools/bin/sdkmanager" || true
          # Também cria outros binários necessários se existirem
          for tool in avdmanager; do
            if [ -f "$SDK_PATH/cmdline-tools/latest/bin/$tool" ]; then
              ln -sf "$SDK_PATH/cmdline-tools/latest/bin/$tool" "$SDK_PATH/tools/bin/$tool" || true
            fi
          done
        fi
        
        echo "=== Aceitando licenças do SDK ==="
        # Tenta aceitar licenças antes do build usando sdkmanager se disponível
        # Tenta usar o caminho novo primeiro, depois o antigo (symlink)
        CMDLINE_TOOLS="$SDK_PATH/cmdline-tools/latest/bin/sdkmanager"
        OLD_SDKMANAGER="$SDK_PATH/tools/bin/sdkmanager"
        
        if [ -f "$CMDLINE_TOOLS" ]; then
          echo "Aceitando licenças via sdkmanager (cmdline-tools)..."
          yes | "$CMDLINE_TOOLS" --licenses 2>&1 | head -50 || true
        elif [ -f "$OLD_SDKMANAGER" ]; then
          echo "Aceitando licenças via sdkmanager (tools)..."
          yes | "$OLD_SDKMANAGER" --licenses 2>&1 | head -50 || true
        fi
        
        # Instala platform-tools se necessário
        if [ -f "$CMDLINE_TOOLS" ]; then
          echo "=== Instalando Android SDK platform-tools ==="
          yes | "$CMDLINE_TOOLS" "platform-tools" 2>&1 | head -20 || true
        fi
        
        echo "=== Baixando SDK manualmente antes do build ==="
        # Baixa o SDK usando python-for-android antes do buildozer começar
        # Isso garante que o SDK esteja disponível e podemos criar o symlink
        if [ ! -d "$SDK_PATH/platforms" ]; then
          echo "SDK não encontrado, será baixado pelo buildozer..."
        fi
        
        echo "=== Garantindo symlink antes do build ==="
        # Cria o symlink se o cmdline-tools existir
        if [ -f "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" ]; then
          mkdir -p "$SDK_PATH/tools/bin"
          if [ ! -f "$SDK_PATH/tools/bin/sdkmanager" ]; then
            echo "=== Criando symlink para sdkmanager ==="
            ln -sf "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" "$SDK_PATH/tools/bin/sdkmanager"
            echo "Symlink criado: $(ls -la $SDK_PATH/tools/bin/sdkmanager 2>/dev/null || echo 'não encontrado')"
          fi
        fi
        
        echo "=== Iniciando build com monitoramento de SDK ==="
        # Cria um script wrapper que monitora e cria symlink quando SDK for baixado
        cat > /tmp/monitor_sdk.sh << 'EOF'
#!/bin/bash
SDK_PATH="$HOME/.buildozer/android/platform/android-sdk"
while true; do
  if [ -f "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" ] && [ ! -f "$SDK_PATH/tools/bin/sdkmanager" ]; then
    echo "=== SDK detectado, criando symlink ==="
    mkdir -p "$SDK_PATH/tools/bin"
    ln -sf "$SDK_PATH/cmdline-tools/latest/bin/sdkmanager" "$SDK_PATH/tools/bin/sdkmanager" 2>/dev/null || true
    break
  fi
  sleep 2
done
EOF
        chmod +x /tmp/monitor_sdk.sh
        
        # Inicia o monitoramento em background
        /tmp/monitor_sdk.sh &
        MONITOR_PID=$!
        
        # O buildozer.spec já tem android.accept_sdk_license = True
        # Executa o build e captura a saída
        buildozer -v android debug 2>&1 | tee build.log || {
          kill $MONITOR_PID 2>/dev/null || true
          EXIT_CODE=$?
          # Se falhar, tenta aceitar licenças e tentar novamente
          if [ -d "$SDK_PATH/cmdline-tools" ]; then
            echo "=== Tentando aceitar licenças após falha ==="
            CMDLINE_TOOLS=$(find "$SDK_PATH/cmdline-tools" -name "sdkmanager" -type f | head -1)
            if [ -n "$CMDLINE_TOOLS" ]; then
              yes | "$CMDLINE_TOOLS" --licenses 2>&1 || true
              cp -r ~/.android/licenses/* "$SDK_PATH/licenses/" 2>/dev/null || true
              echo "=== Tentando build novamente ==="
              /tmp/monitor_sdk.sh &
              MONITOR_PID2=$!
              buildozer -v android debug 2>&1 | tee build-retry.log || {
                kill $MONITOR_PID2 2>/dev/null || true
                EXIT_CODE=$?
                echo "=== Build falhou novamente com código: $EXIT_CODE ==="
                
                # Verifica se APK foi gerado mesmo assim
                APK_FOUND=$(find .buildozer -name "*.apk" 2>/dev/null | head -1 || echo "")
                if [ -n "$APK_FOUND" ]; then
                  echo "✅ APK encontrado apesar do erro: $APK_FOUND"
                  echo "APK_PATH=$APK_FOUND" >> $GITHUB_ENV
                  exit 0
                fi
                
                echo "=== Erros encontrados ==="
                grep -i "error\|fail\|exception" build.log build-retry.log 2>/dev/null | tail -50 || true
                echo "=== Últimas 200 linhas ==="
                tail -200 build.log
                exit $EXIT_CODE
              }
            fi
          fi
          
          # Para o monitoramento
          kill $MONITOR_PID 2>/dev/null || true
          
          EXIT_CODE=$?
          echo "=== Build falhou com código: $EXIT_CODE ==="
          
          # Verifica se APK foi gerado mesmo assim
          APK_FOUND=$(find .buildozer -name "*.apk" 2>/dev/null | head -1 || echo "")
          if [ -n "$APK_FOUND" ]; then
            echo "✅ APK encontrado apesar do erro: $APK_FOUND"
            echo "APK_PATH=$APK_FOUND" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "=== Erros encontrados ==="
          grep -i "error\|fail\|exception" build.log | tail -50 || true
          echo "=== Últimas 200 linhas ==="
          tail -200 build.log
          exit $EXIT_CODE
        }
        
        echo "=== Build concluído ==="
        APK_PATH=$(find .buildozer -name "*.apk" 2>/dev/null | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "❌ Nenhum APK encontrado!"
          echo "=== Procurando em todos os lugares ==="
          find .buildozer -type f -name "*.apk" 2>/dev/null || true
          ls -la .buildozer/android/platform/build/dists/*/bin/ 2>/dev/null || true
          exit 1
        fi
        echo "✅ APK encontrado: $APK_PATH"
        ls -lh "$APK_PATH"
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: ${{ env.APK_PATH }}
        retention-days: 30
      if: env.APK_PATH != ''
